<?php
/**
 * @file
 * Module file for the ERCore Admin module.
 */

/**
 * Implements hook_permission().
 */
function ercore_admin_permission() {
  return array(
    'access ercore admin help' => array(
      'title' => t('Access ERCore Admin Help Page'),
      'description' => t('Allow users to access Administrative Help Page.'),
    ),
  );
}

/**
 * Implements hook_help().
 */
function ercore_admin_help($path, $arg) {
  switch ($path) {
    case 'admin/help#ercore_admin':
      return t("Testing.");
  }
}

/**
 * Implements hook_menu().
 */
function ercore_admin_menu() {
  $items['reporting'] = array(
    'title' => 'Accomplishments',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ercore_reporting_callback'),
    'access arguments' => array('access ercore admin content'),
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'main-menu',
    'file' => '/pages/ercore-reporting.inc',
  );
  $items['ercore'] = array(
    'menu_name' => 'ercore_admin_menu',
    'title' => 'ERCore',
    'description' => 'ERCore is a Drupal project to assist in the collection,
    display, and preparatio of EPSCoR grant data.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access ercore admin content'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  // ERCore Content Menu, accomplishments table views point here.
  $items['ercore/content'] = array(
    //'menu_name' => 'ercore_admin_menu',
    'title' => 'ERCore Content',
    'description' => 'All ERCore related content types that come with the
    ER-Core module in populating the reporting tables are located in ERCore
    Content. ',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  // Administration views point here.
  $items['ercore/views'] = array(
   'title' => 'Administrative Views',
    'description' => 'At a glance ERCore generated reporting views related to
    NSF Reporting Tables are available here. In addition, other views such as
    flagged items for review are available in this menu flyout.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  // Administrative actions menu.
  $items['ercore/actions'] = array(
    'title' => 'Administrative Actions',
    'description' => 'Administrative actions for administrators and staff.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access ercore admin content'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  $items['ercore/actions/new-inst'] = array(
    'title' => 'Create New Institution',
    'description' => 'This page allows administrators to add new institutions.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('node/add/er-institution'),
    'access arguments' => array('access ercore admin content'),
  );
  $items['ercore/actions/new-user'] = array(
    'title' => 'Create New User',
    'description' => 'This page allows administrators to register new users.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('admin/people/create'),
    'access arguments' => array('administer users'),
  );
  // ERCore module administrative pages.
  $items['ercore/actions/config'] = array(
    'title' => 'ERCore Reporting Core Settings',
    'description' => 'This area is specific to ERCore grant start dates as well as reporting period dates.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('admin/config/ercore/admin'),
    'access arguments' => array('administer ercore module'),
  );
  // NSF TABLE VIEWS:
  $items['ercore/views/salary-support'] = array(
    'title' => 'NSF Table A - Salary Support',
    'description' => 'This view aims to help you determine where the Salary Support information is coming from.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/salary-support'),
    'access arguments' => array('access ercore admin content'),
  );
  $items['ercore/views/participants'] = array(
    'title' => 'NSF Table B - Participants',
    'description' => 'This view aims to help you determine where the Participant information is coming from.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/participants'),
    'access arguments' => array('access ercore admin content'),
  );
  $items['ercore/views/collaborations'] = array(
    'title' => 'NSF Table C - Collaborations',
    'description' => 'This view aims to help you determine where the Collaborator counts are coming from.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/collaborations'),
    'access arguments' => array('access ercore admin content'),
  );
  $items['ercore/views/external-engagement'] = array(
    'title' => 'NSF Table D - External Engagements',
    'description' => 'This view aims to help you determine where the External Engagement counts are coming from.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/external-engagement'),
    'access arguments' => array('access ercore admin content'),
  );
  $items['ercore/views/outputs'] = array(
    'title' => 'NSF Table E - Outputs',
    'description' => 'This view aims to help you determine where the Outputs counts are coming from.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/outputs'),
    'access arguments' => array('access ercore admin content'),
  );

  // Links to content views.
  $content_views = array(
    "calendar" => "Calendar Events",
    "collaborations" => "Collaborations",
    "collaborators" => "External Collaborators",
    "external-engagements" => "External Engagements",
    "highlights" => "Highlights",
    "awards" => "Honors and Awards",
    "institutions" => "Institutions",
    "other-research-products" => "Other Research Products",
    "participants" => "Participants",
    "patents" => "Patents",
    "presentations" => "Presentations",
    "proposals" => "Proposal or Grant",
    "publications" => "Publications",
  );
  foreach ($content_views as $url => $label) {
    $items['ercore/content/' . $url] = array(
      'title' => $label,
      'type' => MENU_NORMAL_ITEM,
      'page callback' => 'drupal_goto',
      'page arguments' => array($url),
      'access arguments' => array('access ercore content'),
    );
  }

  $items['ercore/reporting'] = array(
    'title' => 'Accomplishments',
    'description' => 'This page shows all categories of accomplishments (collaborations, grants & proposals, external engagements, etc) with the option of selecting by reporting year/period.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting'),
    'access arguments' => array('access ercore content'),
  );
  $items['ercore/reporting/download'] = array(
    'title' => 'Download Reporting Tables',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_goto',
    'page arguments' => array('reporting/download'),
    'access arguments' => array('access ercore excel sheets'),
  );
  $items['ercore/guides'] = array(
    'title' => 'User Guides',
    'description' => 'Reference guides for ERCore administrators and users.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  $items['ercore/guides/admin-guide'] = array(
    'title' => 'Administrative Guide',
    'description' => 'A reference and guide for administrator and staff.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'ercore_admin_guide_callback',
    'access arguments' => array('access ercore content'),
    'file' => '/pages/ercore-admin-guide.inc',
  );
  $items['ercore/guides/user-guide'] = array(
    'title' => 'User Guide',
    'description' => 'A reference and guide for the ERCore user.',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'ercore_user_guide_callback',
    'access arguments' => array('access ercore content'),
    'file' => '/pages/ercore-user-guide.inc',
  );
  $items['ercore/participants'] = array(
    'title' => 'Participant Views',
    'description' => 'Views for administrating Participants.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  return $items;
}

/**
 * Constructs the epscor page.
 *
 * Our menu maps this function to the path 'epscor'.
 */
function ercore_epscor_callback() {
  return array(
    '#markup' =>
    t('Testing'),
  );
}

/**
 * Implements hook_views_api().
 */
function ercore_admin_views_api($module, $api) {
  if ($module == 'views' && $api == 'views_default') {
    return array('version' => 2);
  }
}


/**
 * Implements hook_preprocess_user_profile().
 */
function ercore_admin_preprocess_user_profile(&$vars) {
  if ($vars['elements']['#view_mode'] == 'user_institution') {
    $vars['theme_hook_suggestions'][] = 'user_profile__user_institution';
  }
}

/**
 * Implements hook_theme_registry_alter().
 */

function ercore_admin_theme_registry_alter(&$theme_registry) {
  // Get the path to this module.
  $modulepath = drupal_get_path('module', 'ercore_admin');

  // Find all .tpl.php files in this module's folder recursively.
  $template_file_objects = drupal_find_theme_templates($theme_registry, '.tpl.php', $modulepath);

  // Iterate through all found template file objects.
  foreach ($template_file_objects as $key => $template_file_object) {

    // If the template has not already been overridden by a theme.
    if (!isset($theme_registry[$key]['theme path']) || !preg_match('#/themes/#', $theme_registry[$key]['theme path'])) {
      // Alter the theme path and template elements.
      $theme_registry[$key]['theme path'] = $modulepath;
      $theme_registry[$key] = array_merge($theme_registry[$key], $template_file_object);
      $theme_registry[$key]['type'] = 'module';
    }
  }
}

/**
 * Implements hook_theme().
 */
function ercore_admin_theme($existing, $type, $theme, $path) {
  $theme = array(
    'ercore_summary_table' => array(
      'variables' => array(
        'ranges' => array(),
        'debug' => FALSE,
      ),
      'function' => 'ercore_summary_table',
    ),
  );
  return $theme;
}


/**
 * Implements hook_form_alter().
 * Converts Summary views exposed filters to predefined format.
 */
function ercore_admin_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'views_exposed_form') {
    if (strpos($form['#id'], 'ercore-summary-') !== FALSE) {

      $format = variable_get('date_format_ercore_date_format_filter');
      $form['start-date']['value']['#date_format'] = $format;
      $form['end-date']['value']['#date_format'] = $format;
    }
  }
}

/*
 * Creates download links.
 */
function ercore_download_link($label, $arg = "", $options = array()){
  $options += array(
    'html'=>true,
    'attributes' => array('class' => 'download-link')
  );
  if (!$arg) $arg = arg(1);
  if (!$label) $label = "Download this page";
  return l(t($label), $GLOBALS['base_url'] . "/reporting/$arg/download", $options);
}

